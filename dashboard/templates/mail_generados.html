{% extends "base.html" %}

{% block titulo %}Historial de Emails{% endblock %}
{% block subtitulo %}Todos los emails generados y verificados.{% endblock %}

{% block contenido %}
<div class="glass card">
  <h3>ğŸ“Š Historial de Emails</h3>

  <!-- ESTADÃSTICAS -->
  <div class="cards-row">
    <div class="info-card info-card--blue">
      <div class="info-card__label">Total Generados</div>
      <div class="info-card__value">{{ total }}</div>
    </div>
    <div class="info-card info-card--green">
      <div class="info-card__label">âœ… Verificados</div>
      <div class="info-card__value">{{ existe_count }}</div>
    </div>
    <div class="info-card info-card--yellow">
      <div class="info-card__label">âŒ No Existen</div>
      <div class="info-card__value">{{ no_existe_count }}</div>
    </div>
  </div>

  <!-- TABLA -->
  {% if emails %}
  <div class="panel">
    <div class="panel__header">
      <h3 class="panel__title">ğŸ“§ Emails ({{ emails|length }} total)</h3>
    </div>

    <table class="table--compact">
      <thead>
        <tr>
          <th>Email</th>
          <th>Nombre</th>
          <th>Proveedor</th>
          <th>Estado</th>
          <th>AcciÃ³n</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody>
        {% for e in emails %}
        <tr id="row-{{ e.email }}">
          <td><code>{{ e.email }}</code></td>
          <td>{{ e.nombre }} {{ e.apellido or '' }}</td>
          <td>
            <span class="badge-proveedor">{{ e.proveedor or 'N/A' }}</span>
          </td>
          <td>
            <span id="status-{{ e.email }}" class="status-badge {% if e.existe_en_proveedor == True %}status-exists{% elif e.existe_en_proveedor == False %}status-not-exists{% else %}status-pending{% endif %}">
              {% if e.existe_en_proveedor == True %}
                âœ… SÃ­
              {% elif e.existe_en_proveedor == False %}
                âŒ No
              {% else %}
                â³ Pendiente
              {% endif %}
            </span>
          </td>
          <td>
            {% if e.existe_en_proveedor == None %}
              <button type="button" class="btn-verificar" onclick="abrirVerificacion('{{ e.email }}', '{{ e.proveedor }}')">
                ğŸ”— Verificar
              </button>
            {% else %}
              <button type="button" class="btn-copiar" onclick="copiar('{{ e.email }}')">
                ğŸ“‹ Copiar
              </button>
            {% endif %}
          </td>
          <td>
            {% if e.created_at %}
              {{ e.created_at[:10] }}
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% else %}
  <div style="text-align: center; padding: 40px; background: rgba(34, 197, 94, 0.1); border-radius: 12px;">
    <p style="color: var(--text-muted); margin: 0;">
      ğŸ“­ No hay emails generados aÃºn. <a href="{{ url_for('mail_generator') }}" style="color: var(--accent); font-weight: 600; text-decoration: none;">Genera uno ahora â†’</a>
    </p>
  </div>
  {% endif %}
</div>

<!-- MODAL: ConfirmaciÃ³n de verificaciÃ³n -->
<div id="modal-verificar" class="modal">
    <div class="modal-content">
        <button type="button" onclick="cerrarModal()" class="modal-close">âœ•</button>
        
        <h2>ğŸ” Verificar Email</h2>
        
        <div class="modal-email-box">
            <p><strong>Email:</strong> <span id="email-modal" class="email-code"></span></p>
            <p><strong>Proveedor:</strong> <span id="proveedor-modal" class="proveedor-code"></span></p>
        </div>
        
        <ol class="modal-instructions">
            <li><strong>Haz click en "Abrir Proveedor"</strong> - Se abrirÃ¡ en nueva pestaÃ±a</li>
            <li><strong>Intenta recuperar la cuenta</strong> - Ingresa el email para verificar</li>
            <li><strong>Observa la respuesta del proveedor</strong></li>
            <li><strong>Vuelve a esta pestaÃ±a</strong> - Selecciona si existe o no</li>
            <li><strong>El resultado se guarda automÃ¡ticamente</strong></li>
        </ol>
        
        <button type="button" id="btn-abrir" onclick="abrirProveedor()" class="btn-modal-primary">
            ğŸŒ Abrir Proveedor
        </button>
        
        <p class="modal-question">Â¿Existe el email en este proveedor?</p>
        <div class="modal-buttons">
            <button type="button" onclick="guardarResultado(true)" class="btn-modal-success">
                âœ… SÃ­, existe
            </button>
            <button type="button" onclick="guardarResultado(false)" class="btn-modal-error">
                âŒ No existe
            </button>
        </div>
    </div>
</div>

<script>
let emailActual = "";
let proveedorActual = "";

function copiar(email) {
  navigator.clipboard.writeText(email);
  alert('âœ… ' + email + ' copiado al portapapeles');
}

function abrirVerificacion(email, proveedor) {
    emailActual = email;
    proveedorActual = proveedor;
    
    document.getElementById("email-modal").textContent = emailActual;
    document.getElementById("proveedor-modal").textContent = proveedorActual;
    document.getElementById("modal-verificar").style.display = "flex";
}

function cerrarModal() {
    document.getElementById("modal-verificar").style.display = "none";
}

function abrirProveedor() {
    fetch(`/verificar-email/${encodeURIComponent(emailActual)}/${proveedorActual}`)
        .then(r => r.json())
        .then(data => {
            if (data.url) {
                window.open(data.url, '_blank');
            } else {
                alert("Error: No se pudo abrir el proveedor");
            }
        })
        .catch(err => {
            console.error("Error:", err);
            alert("Error al conectar");
        });
}

function guardarResultado(existe) {
    if (!emailActual) {
        alert("Error: Email no definido");
        return;
    }
    
    const data = {
        email: emailActual,
        existe: existe
    };
    
    fetch("/guardar-verificacion-email", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(res => {
        if (res.success) {
            alert("âœ… Resultado guardado!");
            cerrarModal();
            setTimeout(() => {
                location.reload();
            }, 500);
        } else {
            alert("âŒ Error: " + res.error);
        }
    })
    .catch(err => {
        console.error("Error:", err);
        alert("Error al guardar");
    });
}
</script>

<!-- Botones de navegaciÃ³n -->
<div style="margin-top: 20px; display: flex; gap: 10px;">
  <a href="{{ url_for('mail_generator') }}" class="btn-link">â† Volver al Generador</a>
  <a href="{{ url_for('general') }}" class="btn-link">â† Dashboard</a>
</div>

{% endblock %}
