{% extends "base.html" %}

{% block titulo %}Generador de Emails{% endblock %}
{% block subtitulo %}Genera y verifica emails @gmail.com automÃ¡ticamente.{% endblock %}

{% block contenido %}
<div class="glass card">
  <h3>ğŸ¯ Generar y Verificar Emails</h3>
  
  <!-- FORMULARIO -->
  <form action="{{ url_for('generar_email') }}" method="post" class="inline-form">
    <input type="text" name="nombre" placeholder="Nombre" required>
    <input type="text" name="apellido" placeholder="Apellido" required>
    <input type="text" name="numero" placeholder="NÃºmero (opcional)">
    <button type="submit" class="btn-primary">ğŸš€ Generar</button>
  </form>

  <!-- ESTADÃSTICAS -->
  {% if total > 0 %}
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 30px; margin-bottom: 30px;">
    
    <!-- Card: Total -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; text-align: center;">
      <div style="font-size: 28px; font-weight: bold;">{{ total }}</div>
      <div style="font-size: 12px; opacity: 0.9;">Total</div>
    </div>
    
    <!-- Card: Existen -->
    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px; border-radius: 8px; text-align: center;">
      <div style="font-size: 28px; font-weight: bold;">{{ existe_count }}</div>
      <div style="font-size: 12px; opacity: 0.9;">âœ… Existen</div>
    </div>
    
    <!-- Card: No Existen -->
    <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 15px; border-radius: 8px; text-align: center;">
      <div style="font-size: 28px; font-weight: bold;">{{ no_existe_count }}</div>
      <div style="font-size: 12px; opacity: 0.9;">âŒ No Existen</div>
    </div>

    <!-- Card: Pendientes -->
    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 15px; border-radius: 8px; text-align: center;">
      <div style="font-size: 28px; font-weight: bold;">{{ pendiente_count }}</div>
      <div style="font-size: 12px; opacity: 0.9;">â³ Pendientes</div>
    </div>
  </div>
  {% endif %}

  <!-- TABLA DE RESULTADOS -->
  {% if variantes %}
  <div style="margin-top: 30px;">
    <h4>ğŸ“§ Resultados ({{ variantes|length }} variantes):</h4>
    <table class="table--compact">
      <thead>
        <tr>
          <th>Email</th>
          <th>Estado</th>
          <th>AcciÃ³n</th>
        </tr>
      </thead>
      <tbody>
        {% for v in variantes %}
        <tr id="row-{{ v.email }}">
          <td><code>{{ v.email }}</code></td>
          <td>
            <span id="status-{{ v.email }}" style="display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: #fef3c7; color: #92400e;">
              â³ Verificando...
            </span>
          </td>
          <td>
            <button type="button" class="btn-secondary" id="btn-{{ v.email }}" onclick="verificarEmail('{{ v.email }}', '{{ nombre }}', '{{ apellido }}')" style="display: none;">ğŸ” Verificar</button>
            <button type="button" class="btn-secondary" id="copy-{{ v.email }}" onclick="copiar('{{ v.email }}')" style="display: none;">ğŸ“‹ Copiar</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Auto-actualizar resultados cada 3 segundos -->
  <script>
    const emailsToCheck = {{ variantes|tojson }};
    
    function actualizarEstados() {
      emailsToCheck.forEach(v => {
        const statusEl = document.getElementById('status-' + v.email);
        const btnVerificar = document.getElementById('btn-' + v.email);
        const btnCopiar = document.getElementById('copy-' + v.email);
        
        if (!statusEl) return;

        // Fetch al endpoint para obtener estado actualizado
        fetch(`/obtener-estado-email/${encodeURIComponent(v.email)}`)
          .then(r => r.json())
          .then(data => {
            if (data.existe === true) {
              statusEl.style.background = '#d1fae5';
              statusEl.style.color = '#065f46';
              statusEl.innerHTML = 'âœ… Existe';
              btnCopiar.style.display = 'inline-block';
              btnVerificar.style.display = 'none';
            } else if (data.existe === false) {
              statusEl.style.background = '#fee2e2';
              statusEl.style.color = '#991b1b';
              statusEl.innerHTML = 'âŒ No existe';
              btnVerificar.style.display = 'inline-block';
              btnCopiar.style.display = 'none';
            } else {
              statusEl.style.background = '#fef3c7';
              statusEl.style.color = '#92400e';
              statusEl.innerHTML = 'â³ Verificando...';
              btnVerificar.style.display = 'none';
              btnCopiar.style.display = 'none';
            }
          })
          .catch(e => console.log('Error:', e));
      });
    }

    // Actualizar cada 3 segundos
    setInterval(actualizarEstados, 3000);
    
    // Actualizar inmediatamente
    actualizarEstados();
  </script>
  {% endif %}

  <!-- INSTRUCCIONES -->
  <div style="margin-top: 30px; background: #ede9fe; border-left: 4px solid #667eea; padding: 15px; border-radius: 6px;">
    <h4 style="margin-top: 0; color: #667eea;">ğŸ“‹ CÃ³mo funciona:</h4>
    <ol style="margin: 10px 0; padding-left: 20px;">
      <li>Ingresa <strong>Nombre</strong> y <strong>Apellido</strong></li>
      <li>Haz click en "Generar"</li>
      <li>El sistema genera automÃ¡ticamente variantes de emails</li>
      <li><strong>Selenium abre Chrome automÃ¡ticamente cada 60 segundos</strong> para verificar</li>
      <li>Los resultados se muestran en vivo en la tabla â¬†ï¸</li>
      <li>Puedes verificar manualmente con el botÃ³n "ğŸ” Verificar"</li>
      <li>Copia los emails existentes con "ğŸ“‹ Copiar"</li>
    </ol>
  </div>

</div>

<!-- MODAL: Instrucciones de verificaciÃ³n -->
<div id="modal-verificar" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; color: var(--text-main);">
        
        <button type="button" onclick="cerrarModal()" style="float: right; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted);">âœ•</button>
        
        <h2 style="color: var(--text-main); margin-bottom: 20px; margin-top: 0;">ğŸ“Œ CÃ³mo verificar</h2>
        
        <div style="background: rgba(34, 197, 94, 0.1); padding: 15px; border-left: 4px solid var(--accent); margin-bottom: 20px; border-radius: 8px;">
            <p style="margin: 0; color: var(--text-main); font-size: 14px;">
                <strong>Email a verificar:</strong> <span id="email-modal" style="font-family: monospace; color: var(--accent);"></span>
            </p>
        </div>
        
        <ol style="color: var(--text-main); line-height: 1.8; margin-bottom: 20px;">
            <li><strong>Haz click en "Abrir Google"</strong> - Se abrirÃ¡ en nueva pestaÃ±a</li>
            <li><strong>FÃ­jate si el email existe</strong> - Google mostrarÃ¡ si es vÃ¡lido</li>
            <li><strong>Vuelve a esta pestaÃ±a</strong> - Selecciona el resultado</li>
            <li><strong>Se guarda automÃ¡ticamente</strong> - En tu base de datos</li>
        </ol>
        
        <button type="button" id="btn-google" onclick="abrirGoogle()" style="width: 100%; padding: 12px; background-color: var(--accent); color: #022c22; border: none; border-radius: 999px; font-weight: 600; cursor: pointer; margin-bottom: 15px; font-size: 0.9rem;">
            ğŸŒ Abrir Google
        </button>
        
        <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 10px;">Â¿Existe el email en Google?</p>
        <div style="display: flex; gap: 10px;">
            <button type="button" onclick="guardarResultado(true)" style="flex: 1; padding: 12px; background-color: #22c55e; color: #022c22; border: none; border-radius: 999px; font-weight: 600; cursor: pointer; font-size: 0.9rem;">
                âœ… SÃ­, existe
            </button>
            <button type="button" onclick="guardarResultado(false)" style="flex: 1; padding: 12px; background-color: #ef4444; color: white; border: none; border-radius: 999px; font-weight: 600; cursor: pointer; font-size: 0.9rem;">
                âŒ No existe
            </button>
        </div>
    </div>
</div>

<script>
let emailActual = "";
let nombreActual = "";
let apellidoActual = "";

function copiar(email) {
  navigator.clipboard.writeText(email);
  alert('âœ… ' + email + ' copiado al portapapeles');
}

function verificarEmail(email, nombre, apellido) {
    console.log("Email:", email, "Nombre:", nombre, "Apellido:", apellido);
    emailActual = email;
    nombreActual = nombre;
    apellidoActual = apellido;
    
    document.getElementById("email-modal").textContent = emailActual;
    document.getElementById("modal-verificar").style.display = "flex";
}

function cerrarModal() {
    document.getElementById("modal-verificar").style.display = "none";
}

function abrirGoogle() {
    const googleUrl = "/verificar-email-gmail/" + encodeURIComponent(emailActual);
    fetch(googleUrl)
        .then(r => r.json())
        .then(data => {
            if (data.url) {
                window.open(data.url, '_blank');
            } else {
                alert("Error: No se pudo abrir Google");
            }
        })
        .catch(err => {
            console.error("Error:", err);
            alert("Error al conectar con Google");
        });
}

function guardarResultado(existe) {
    if (!emailActual) {
        alert("Error: Email no definido");
        return;
    }
    
    const data = {
        email: emailActual,
        existe: existe,
        nombre: nombreActual,
        apellido: apellidoActual
    };
    
    console.log("Guardando:", data);
    
    fetch("/guardar-verificacion-email", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(res => {
        console.log("Respuesta:", res);
        if (res.success) {
            alert("âœ… Email guardado correctamente!");
            cerrarModal();
            // Actualizar tabla sin recargar
            setTimeout(() => {
                actualizarEstados();
            }, 500);
        } else {
            alert("âŒ Error: " + res.error);
        }
    })
    .catch(err => {
        console.error("Error:", err);
        alert("Error al guardar");
    });
}
</script>

</div>

<!-- Botones de navegaciÃ³n -->
<div style="margin-top: 20px; display: flex; gap: 10px;">
  <a href="{{ url_for('mail_generados') }}" class="btn-link">ğŸ“Š Ver historial de emails generados â†’</a>
  <a href="{{ url_for('general') }}" class="btn-link">â† Volver al Dashboard</a>
</div>

{% endblock %}
